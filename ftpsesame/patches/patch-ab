$NetBSD: patch-ab,v 1.1.1.1 2004/11/10 18:33:30 ppostma Exp $

--- ftpsesame.c.orig	2004-10-05 14:07:24.000000000 +0200
+++ ftpsesame.c	2004-11-07 23:38:41.000000000 +0100
@@ -19,14 +19,17 @@
 #include <sys/ioctl.h>
 
 #include <net/if.h>
-#include <net/pfvar.h>
 #include <net/ppp_defs.h>
-#include <netinet/if_ether.h>
+
 #include <netinet/in.h>
 #include <netinet/in_systm.h>
 #include <netinet/ip.h>
+#include <netinet/if_ether.h>
 #include <netinet/tcp.h>
 #include <netinet/tcp_fsm.h>
+
+#include <net/pfvar.h>
+
 #include <arpa/inet.h>
 
 #include <ctype.h>
@@ -46,7 +49,7 @@
 #include "state.h"
 
 #define NOPRIV_USER	"proxy"
-#define CHROOT_DIR	"/var/empty"
+#define CHROOT_DIR	"/var/chroot/proxy"
 
 #define PCAP_TO_MS	500
 #define PURGE_INTERVAL	60
@@ -519,10 +522,12 @@
 		err(1, "BIOCIMMEDIATE");
 	wfilter.bf_len = 1;
 	wfilter.bf_insns = blockall;
+#ifdef __OpenBSD__
 	if (ioctl(pcap_fileno(hpcap), BIOCSETWF, &wfilter) < 0)
 		err(1, "BIOCSETWF");
 	if (ioctl(pcap_fileno(hpcap), BIOCLOCK) < 0)
 		err(1, "BIOCLOCK");
+#endif
 
 	if (daemonize) {
 		if (daemon(0, 0) == -1)
@@ -626,10 +631,16 @@
 	chdir("/");
 
 	gidset[0] = pw->pw_gid;
+#ifdef __OpenBSD__
 	if (setgroups(1, gidset) == -1 || setegid(pw->pw_gid) == -1 ||
 	    setgid(pw->pw_gid) == -1 || seteuid(pw->pw_uid) == -1 ||
 	    setuid(pw->pw_uid) == -1)
 		return (0);
+#else
+	if (setgroups(1, gidset) == -1 || setgid(pw->pw_gid) == -1 ||
+	    setuid(pw->pw_uid) == -1)
+		return (0);
+#endif
 	
 	return (1);
 }
