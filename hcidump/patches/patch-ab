$NetBSD: patch-ab,v 1.2 2005/11/14 23:43:28 plunky Exp $

--- hcidump/hcidump.c.orig	2004-03-03 18:52:10.000000000 +0000
+++ hcidump/hcidump.c
@@ -34,12 +34,13 @@
 #include <getopt.h>
 #include <stdio.h>
 #include <stdlib.h>
+#include <sys/ioctl.h>
 #include <string.h>
 #include <unistd.h>
 
-#include <netgraph/bluetooth/include/ng_hci.h>
-#include <netgraph/bluetooth/include/ng_l2cap.h>
-#include <netgraph/bluetooth/include/ng_btsocket.h>
+#include <bluetooth/bluetooth.h>
+#include <bluetooth/hci.h>
+#include <bluetooth/l2cap.h>
 
 #include "parser.h"
 #include "hcidump.h"
@@ -112,7 +113,7 @@ static void process_frames(char *dev, in
 	}
 	
 	printf("device: %s snap_len: %d filter: 0x%lx\n", 
-		dev? dev : "any", snap_len, filter);
+		dev ? dev : "any", snap_len, filter);
 
 	if (getuid() != 0)
 		printf(
@@ -139,8 +140,8 @@ static void process_frames(char *dev, in
 		frm.in = 0;
 		cmsg = CMSG_FIRSTHDR(&msg);
 		while (cmsg) {
-			if (cmsg->cmsg_level == SOL_HCI_RAW &&
-			    cmsg->cmsg_type == SCM_HCI_RAW_DIRECTION)
+			if (cmsg->cmsg_level == BLUETOOTH_PROTO_HCI &&
+			    cmsg->cmsg_type == SCM_HCI_DIRECTION)
 				memcpy(&frm.in,CMSG_DATA(cmsg),sizeof(frm.in));
 
 			if (cmsg->cmsg_level == SOL_SOCKET &&
@@ -210,16 +211,16 @@ failed:
 	exit(1);
 }
 
-static int open_file(char *file, int mode)
+static int open_file(char *file, int m)
 {
-	int f, flags;
+	int f, fl;
 
-	if (mode == WRITE)
-		flags = O_WRONLY | O_CREAT | O_APPEND;
+	if (m == WRITE)
+		fl = O_WRONLY | O_CREAT | O_APPEND;
 	else
-		flags = O_RDONLY;
+		fl = O_RDONLY;
 
-	if ((f = open(file, flags, 0600)) < 0) {
+	if ((f = open(file, fl, 0600)) < 0) {
 		perror("Can't open output file");
 		exit(1);
 	}
@@ -228,8 +229,8 @@ static int open_file(char *file, int mod
 
 static int open_socket(char *dev)
 {
-	struct sockaddr_hci addr;
-	struct ng_btsocket_hci_raw_filter flt;
+	struct sockaddr_bt addr;
+	struct hci_filter flt;
 	int s, opt;
 
 	/* Create HCI socket */
@@ -245,37 +246,55 @@ static int open_socket(char *dev)
 	}
 
 	opt = 1;
-	if (setsockopt(s, SOL_HCI_RAW, SO_HCI_RAW_DIRECTION, &opt, sizeof(opt)) < 0) {
-		perror("Can't enable data direction info");
+	if (setsockopt(s, SOL_SOCKET, SO_TIMESTAMP, &opt, sizeof(opt)) < 0) {
+		perror("Can't enable time stamp");
 		exit(1);
 	}
 
 	opt = 1;
-	if (setsockopt(s, SOL_SOCKET, SO_TIMESTAMP, &opt, sizeof(opt)) < 0) {
-		perror("Can't enable time stamp");
+	if (setsockopt(s, BLUETOOTH_PROTO_HCI, SO_HCI_DIRECTION, &opt, sizeof(opt)) < 0) {
+		perror("Can't enable data direction info");
+		exit(1);
+	}
+
+	/* Setup filters */
+	memset(&flt, 0xff, sizeof(flt));
+	if (setsockopt(s, BLUETOOTH_PROTO_HCI, SO_HCI_EVT_FILTER, (void const *) &flt, sizeof(flt)) < 0) {
+		perror("Can't set HCI Event filter");
 		exit(1);
 	}
 
-	/* Setup filter */
 	memset(&flt, 0xff, sizeof(flt));
-	if (setsockopt(s, SOL_HCI_RAW, SO_HCI_RAW_FILTER, (void const *) &flt, sizeof(flt)) < 0) {
-		perror("Can't set HCI filter");
+	if (setsockopt(s, BLUETOOTH_PROTO_HCI, SO_HCI_PKT_FILTER, (void const *) &flt, sizeof(flt)) < 0) {
+		perror("Can't set HCI Packet filter");
 		exit(1);
 	}
 
 	/* Bind socket to the HCI device */
 	memset(&addr, 0, sizeof(addr));
-	addr.hci_len = sizeof(addr);
-	addr.hci_family = AF_BLUETOOTH;
+	addr.len = sizeof(addr);
+	addr.family = AF_BLUETOOTH;
 	if (dev != NULL) {
-		strncpy(addr.hci_node, dev, sizeof(addr.hci_node));
+		struct btreq btr;
 
-		if (bind(s, (struct sockaddr *)&addr, sizeof(addr)) < 0) {
-			printf("Can't attach to device %s. %s(%d)\n", 
-					dev, strerror(errno), errno);
+		memset(&btr, 0, sizeof(btr));
+		strlcpy(btr.btr_name, dev, HCI_DEVNAME_SIZE);
+
+		if (ioctl(s, SIOCGBTINFO, &btr) < 0) {
+			printf("Can't get device info for '%s': %s(%d)\n",
+				dev, strerror(errno), errno);
 			exit(1);
 		}
+
+		bdaddr_copy(&addr.bdaddr, &btr.btr_bdaddr);
 	}
+
+    	if (bind(s, (struct sockaddr *)&addr, sizeof(addr)) < 0) {
+		printf("Can't bind to device %s. %s(%d)\n", 
+			dev, strerror(errno), errno);
+		exit(1);
+	}
+
 	return s;
 }
 
