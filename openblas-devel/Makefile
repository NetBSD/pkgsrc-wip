# $NetBSD$
#
###########################################################
#                  Generated by fbsd2pkg                  #
#              Thu Sep 21 12:36:18 CDT 2017               #
###########################################################
#
# Build tested on: CentOS 6

DISTNAME=	OpenBLAS-${PORTVERSION}
PKGNAME=	openblas-${PORTVERSION}
DIST_SUBDIR=	openblas
CATEGORIES=	math
MASTER_SITES=	${MASTER_SITE_GITHUB:=xianyi/} \
		http://www.netlib.org/lapack/timing/
DISTFILES=	${DISTNAME}.tar.gz large.tgz timing.tgz
GITHUB_PROJECT=	OpenBLAS
GITHUB_TAG=	v${PORTVERSION}

# NetBSD: Cannot find -lssp*
PKGSRC_USE_SSP=	no

MAINTAINER=	bacon@NetBSD.org
HOMEPAGE=	https://github.com/xianyi/OpenBLAS
COMMENT=	Optimized BLAS library based on GotoBLAS2
# Check this
LICENSE=	modified-bsd

# Test and change if necessary.
# MAKE_JOBS_SAFE=	no

# Just assuming C and C++: Adjust this!
USE_LANGUAGES=	c fortran
USE_TOOLS+=	gmake perl:build

PORTVERSION=	0.2.20

LARGE_FILE=	large.tgz
TIMING_FILE=	timing.tgz
OPENBLAS_SUFX=	r${PORTVERSION}
OPENBLAS_LIBS=	libopenblas libopenblasp
OPENBLAS_SVER=	0
TEST_TARGET=	tests
MAXTHREADS?=	8

.if ${MACHINE_ARCH:M*64} == ""
BUILDFLAGS+=	BINARY32=1
.else
BUILDFLAGS+=	BINARY64=1
.endif

SUBST_CLASSES+=		find
SUBST_STAGE.find=	post-patch
SUBST_SED.find+=	-e "s+%%FIND%%+${FIND}+"
SUBST_SED.find+=	-e "s+%%XARGS%%+${XARGS}+"
SUBST_SED.find+=	-e "s+%%REINPLACE_CMD%%+${REINPLACE_CMD}+"
SUBST_FILES.find+=	${WRKSRC}/Makefile

SUBST_CLASSES+=		compiler
SUBST_STAGE.compiler=	post-patch
SUBST_SED.compiler+=	-e "s+%%FC%%+${FC}+"
SUBST_SED.compiler+=	-e "s+%%CC%%+${CC}+"
SUBST_FILES.compiler+=	${WRKSRC}/Makefile.rule

SUBST_CLASSES+=		arch
SUBST_STAGE.arch=	post-patch
SUBST_SED.arch+=	-e "s+(ARCH)+(ARCH_)+"
SUBST_FILES.arch+=	${WRKSRC}/Makefile.rule
SUBST_FILES.arch+=	${WRKSRC}/Makefile.tail
SUBST_FILES.arch+=	${WRKSRC}/driver/level3/Makefile
SUBST_FILES.arch+=	${WRKSRC}/driver/others/Makefile
SUBST_FILES.arch+=	${WRKSRC}/exports/Makefile
SUBST_FILES.arch+=	${WRKSRC}/interface/Makefile
SUBST_FILES.arch+=	${WRKSRC}/kernel/Makefile
SUBST_FILES.arch+=	${WRKSRC}/kernel/Makefile.L3
SUBST_FILES.arch+=	${WRKSRC}/lapack/laswp/Makefile
SUBST_FILES.arch+=	${WRKSRC}/lapack-netlib/SRC/Makefile
SUBST_FILES.arch+=	${WRKSRC}/lapack-netlib/SRC/VARIANTS/Makefile
SUBST_FILES.arch+=	${WRKSRC}/lapack-netlib/TESTING/MATGEN/Makefile
SUBST_FILES.arch+=	${WRKSRC}/lapack-netlib/LAPACKE/src/Makefile
SUBST_FILES.arch+=	${WRKSRC}/lapack-netlib/LAPACKE/utils/Makefile
SUBST_FILES.arch+=	${WRKSRC}/reference/Makefile

SUBST_CLASSES+=		system
SUBST_STAGE.system=	post-patch
SUBST_SED.system+=	-e "s+(ARCH)+(ARCH_)+"
SUBST_SED.system+=	-e 's+%%LDFLAGS%%+${LDFLAGS}+'
SUBST_SED.system+=	-e 's+%%LOCALBASE%%+${PREFIX}+'
SUBST_SED.system+=	-e 's+%%FIND%%+${FIND}+'
SUBST_SED.system+=	-e 's+%%XARGS%%+${XARGS}+'
SUBST_SED.system+=	-e 's+%%REINPLACE_CMD%%+${REINPLACE_CMD}+'
SUBST_SED.system+=	-e 's+$${CROSS_SUFFIX}+${PREFIX}/bin/+'
SUBST_SED.system+=	-e '/Clang.*OpenMP/g'
SUBST_FILES.system+=	${WRKSRC}/Makefile.system

SUBST_CLASSES+=		threads
SUBST_STAGE.threads=	post-patch
SUBST_SED.threads+=	-e "s+OPENBLAS_NUM_THREADS+OMP_NUM_THREADS+g"
SUBST_FILES.threads+=	${WRKSRC}/test/Makefile
SUBST_FILES.threads+=	${WRKSRC}/ctest/Makefile

# Sets OPSYS, OS_VERSION, MACHINE_ARCH, etc..
# .include "../../mk/bsd.prefs.mk"

# Keep this if there are user-selectable options.
# .include "options.mk"

INSTALLATION_DIRS=	lib

post-extract:
	cd ${DISTDIR}/${DIST_SUBDIR} ; \
		${CP} ${LARGE_FILE} ${TIMING_FILE} ${WRKSRC}
	${MKDIR} ${WRKDIR}/lib

do-build:
	cd ${WRKSRC} ; ${SETENV} ${BUILDFLAGS} NUM_THREADS=1 USE_THREAD=0 \
		${MAKE_PROGRAM} ${MAKE_ARGS}
	${CP} ${WRKSRC}/libopenblas-${OPENBLAS_SUFX}.a ${WRKDIR}/lib/libopenblas.a
	${CP} ${WRKSRC}/libopenblas-${OPENBLAS_SUFX}.so ${WRKDIR}/lib/libopenblas.so.${OPENBLAS_SVER}
	cd ${WRKSRC} ; ${MAKE_PROGRAM} ${MAKE_ARGS} clean
	cd ${WRKSRC} ; ${SETENV} ${BUILDFLAGS} ${BUILDFLAGS_THREAD} \
	${MAKE_PROGRAM} ${MAKE_ARGS}
	${CP} ${WRKSRC}/libopenblasp-${OPENBLAS_SUFX}.a ${WRKDIR}/lib/libopenblasp.a
	${CP} ${WRKSRC}/libopenblasp-${OPENBLAS_SUFX}.so ${WRKDIR}/lib/libopenblasp.so.${OPENBLAS_SVER}

.PHONY: benchmark
benchmark: build
	cd ${WRKSRC} ; ${SETENV} ${BUILDFLAGS} NUM_THREADS=${MAXTHREADS} \
	USE_THREAD=1 ${MAKE_PROGRAM} ${MAKE_ARGS} hpl
	cd ${WRKSRC}/benchmark ; ${SETENV} ${BUILDFLAGS} NUM_THREADS=${MAXTHREADS} \
	USE_THREAD=1 ${BENCHMARK_THREADS_FLAG} ${MAKE_PROGRAM} ${MAKE_ARGS}

do-install:
.for l in ${OPENBLAS_LIBS}
	${INSTALL_DATA} ${WRKDIR}/lib/${l}.a ${DESTDIR}${PREFIX}/lib
	${INSTALL_LIB} ${WRKDIR}/lib/${l}.so.${OPENBLAS_SVER} ${DESTDIR}${PREFIX}/lib
	${LN} -sf ${l}.so.${OPENBLAS_SVER} ${DESTDIR}${PREFIX}/lib/${l}.so
.endfor

.include "options.mk"
.include "../../mk/bsd.pkg.mk"
