#!/bin/sh
#-*-mode:  sh -*-

# Copyright (c) 2010 Aleksey Cheusov <vle@gmx.net>
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

############################################################
# user settable variables

PKG_SRC_SUMMARY_CMD=${PKG_SRC_SUMMARY_CMD-pkg_micro_src_summary}
PKG_SUMMARY=${PKG_SUMMARY-@PACKAGES@/All/pkg_summary.txt}

############################################################
set -e

. pipestatus

export LC_ALL=C

############################################################
PKG_INFO_CMD="${PKG_INFO_CMD-@PKG_INFO_CMD@}"
PKG_DELETE_CMD="${PKG_DELETE_CMD-@PKG_DELETE_CMD@}"
PKG_ADMIN_CMD="${PKG_ADMIN_CMD-@PKG_ADMIN_CMD@}"

############################################################
usage (){
    cat 1>&2 <<EOF
pkg_status - compare versions of installed packages
against pkgsrc source tree or pkg_summary.{txt,gz,bz2}

usage:
  pkg_status -h
  pkg_status -V
  pkg_status -s [-ruaAQDp] [ [--] pkg_info_args ]
  pkg_status -b [-ruaAQD]  [ [--] pkg_info_args ]
  pkg_status -k [-mUd]     [ [--] pkg_info_args or pkg_admin_args ]
  pkg_status -l [-rtREn]

OPTIONS:
  -h         display this help message
  -V         display version
  -r         raw output
  -D         for debugging purposes, temp files are not removed
OPTIONS for -s|-b:
  -s         compare against pkgsrc source tree
  -b         compare against pkg_summary(5) database,
             a path to which is stored in PKG_SUMMARY environment variable
  -u         analyse packages marked as installed by user (the default, see -a)
  -a         analyse all installed packages (see -u)
  -A         by default up-to-date packages are skipped,
             with -A they are output too
  -Q         No noisy reminder about output format
  -p <file>  get PKGPATHs from <file> (instead of pkg_info -QPKGPATH).
             This option makes sense with -s, not with -b.
OPTIONS for -l:
  -l         list leaf packages installed automatically
  -t         output only PKGNAME
  -R         remove automatically installed leaf packages
  -E         the same as -R but with 'pkg_delete -A'
  -n         pass -n to pkg_delete
OPTIONS for -k:
  -m         check checksums of installed files (pkg_admin check)
  -U         check for REQUIRES/PROVIDES coherence (pkg_lint_summary -l)
  -d         check for presense of dependencies (pkg_lint_summary -d)
Environment:
   PKG_SUMMARY      - path to pkg_summary.{txt,gx,bz2},
                      it defaults to @PACKAGES@/All/pkg_summary.txt
   PKG_SRC_SUMMARY_CMD - command for generating micro summary,
                      it defaults to pkg_micro_src_summary,
                      reasonable (but slower) alternative is pkg_src_summary.
Example:
   pkg_status -h
   pkg_status -s
   pkg_status -b
   pkg_status -saQ
   pkg_status -bA
   pkg_status -bar
   pkg_status -s pkg_install bmake bootstrap-mk-files
   pkg_status -srA -- pkg_summary-utils
   pkg_status -sp /etc/interesting_pkgs.conf
   pkg_status -lEn
   pkg_status -km
   pkg_status -kUd
EOF
}
#  pkg_status -o [OPTIONS]
#  -o                     compare against packages served by pkg_online server

set -- `getopt hVsbrAauQDp:ltREnkmUd $PKG_STATUS_OPTIONS $*`

while test $# -ne 0; do
    case "$1" in
	-h)
	    usage
	    exit 0;;
	-V)
	    echo 'pkg_status @VERSION@'
	    exit 0;;
	-s)
	    mode_src=1;;
#	-o)
#	    mode_online=1;;
	-b)
	    mode_bin=1;;
	-r)
	    submode_raw=1;;
	-A)
	    submode_all=1;;
	-u)
	    pkg_info_opts="$pkg_info_opts -u";;
	-a)
	    pkg_info_opts="$pkg_info_opts -a";;
	-Q)
	    quiet=1;;
	-D)
	    debug=1;;
	-p)
	    pkgpaths_fn="$2"
	    shift;;
	-k)
	    mode_checks=1;;
	-m)
	    check_checksums=1;;
	-U)
	    check_reqs_provs=1;;
	-d)
	    check_deps=1;;
	-l)
	    mode_leaves=1;;
	-t)
	    pkgpath_only=1;;
	-R)
	    rem_leaves=1;;
	-E)
	    pkg_delete_opts="$pkg_delete_opts -A"
	    rem_leaves=1;;
	-n)
	    pkg_delete_opts="$pkg_delete_opts -n";;
	--)
	    shift
	    break;;
	-*)
	    echo "Unknown option $1" 1>&2
	    exit 1;;
	*)
	    break;;
    esac
    shift
done

bsd_xargs (){
    if read a; then
	{ printf '%s\n' "$a"; cat; } | xargs "$@"
    fi
}

######################################################################
# top-level options

# temporarty directory
tmp_dir="/tmp/pkg_src_summary.$$"
if test -z "$debug"; then
    trap "rm -rf $tmp_dir" 0 1 2 15
else
    echo "Temp directory: $tmp_dir" 1>&2
fi
mkdir -m 700 "$tmp_dir"

#
if test -z "${mode_src}${mode_bin}${mode_leaves}${mode_checks}"; then
    echo 'Either of the following options must be applied: -s, -b, -k or -l' 1>&2
    exit 1
fi

#
if test $# -eq 0 -a -z "$pkg_info_opts"; then
    pkg_info_opts=-u
fi

######################################################################
# -l
summary2pkgname (){
    sed -n 's,^PKGNAME=,,p' "$@"
}

if test -n "$submode_raw"; then
    leaves_proc (){
	cat "$@"
    }
elif test -n "$pkgpath_only"; then
    leaves_proc (){
	summary2pkgname "$@"
    }
elif test -n "$rem_leaves"; then
    leaves_proc (){
	summary2pkgname | bsd_xargs $PKG_DELETE_CMD $pkg_delete_opts
    }
else
    leaves_proc (){
	awk '/^PKGNAME=/ {pkgname = substr($0, 9)}
	     /^COMMENT=/ {comment = substr($0, 9)}
	     NF == 0 {printf "%-20s %s\n", pkgname, comment;
	              pkgname = comment = ""}
	'  "$@"
    }
fi

get_leaves_summaries (){
    pkg_bin_summary -f PKGNAME,COMMENT,PKGPATH,automatic,REQUIREDBY |
    pkg_grep_summary . 'fields ["automatic"] == "yes" && fields ["REQUIREDBY"] == ""'
}

if test -n "$mode_leaves"; then
    get_leaves_summaries | leaves_proc
    exit 0
fi

######################################################################
# -k
if test -n "$mode_checks"; then
    if test -n "$check_checksums"; then
	echo ' --------------------- checksums --------------------------'
	runpipe_base \
	    $PKG_ADMIN_CMD -qv check "$@" '|' \
	    grep 'fails .* checksum'
	if test "$pipestatus_1" -ne 0 -o "$pipestatus_2" -ne 1; then
	    ex=1
	fi
    fi

    if test -n "$check_reqs_provs$check_deps"; then
	$PKG_INFO_CMD -X -a > $tmp_dir/bin_summary.txt
    fi

    if test -n "$check_reqs_provs"; then
	echo ' --------------- REQUIRES/PROVIDES coherence --------------'
	pkg_lint_summary -l $tmp_dir/bin_summary.txt || ex=1
    fi

    if test -n "$check_deps"; then
	echo ' ---------------------- dependencies ----------------------'
	pkg_lint_summary -d $tmp_dir/bin_summary.txt || ex=1
    fi

    exit $ex
fi

######################################################################
# -s|-b

###
if test -n "$submode_raw"; then
    raw2hr (){
	cat
    }
else
    raw2hr (){
	runpipe0 sort -k3,3 -t' ' '|' \
	awk '
	{
#	    if ($1 == ">") $1 = ">>>";
#	    if ($1 == "-") $1 = "---";
	    if ($1 == "<") $1 = "";
	    printf "%3s %-30s %-15s %-12s %-12s\n", $1, $2, $3, $4, $5
	}'
    }
fi

###
if test -n "$submode_all"; then
    skip_uptodate (){
	cat
    }
else
    skip_uptodate (){
	grep -v '^= ' || true
    }
fi

###
if test -z "$pkgpaths_fn"; then
    pkgpaths_fn=$tmp_dir/pkgs.txt
    generate_pkgpaths (){
	$PKG_INFO_CMD -Q PKGPATH $pkg_info_opts "$@" > "$pkgpaths_fn"
    }
else
    generate_pkgpaths (){
    	true;
    }
fi

###
src_summary_fn=$tmp_dir/src_summary.txt
bin_summary_fn=$tmp_dir/bin_summary.txt
ext_summary_fn=$tmp_dir/ext_summary.txt
res_fn=$tmp_dir/result.txt

show_output_format (){
    if test -z "$quiet" -a -z "$submode_raw"; then
	cat <<EOF
Format of the output:
SIGN PKGPATH PKGBASE VERSION1 [VERSION2]

     SIGN:      newer version is available
            >   only older version is available (problem?)
            =   the same version is available
            -   package disappeared or has been renamed (problem?)
            +   package has been renamed (also see '-' sign)
          [0-9] package is registered at least twice (problem?)
     VERSION1: version of installed package,
     VERSION2: (if any) - version of available package
**********************************************************************
EOF
    fi
}

output_results (){
    if test -s "$res_fn"; then
	show_output_format
	cat "$res_fn"
    else
	echo 'Everything is up-to-date'
    fi
}

########################################
# -s
if test -n "$mode_src"; then
    $PKG_INFO_CMD -X $pkg_info_opts "$@" > "$bin_summary_fn"
    generate_pkgpaths "$@"
    $PKG_SRC_SUMMARY_CMD < "$pkgpaths_fn" > "$src_summary_fn"
    runpipe0 \
	pkg_cmp_summary -p "$bin_summary_fn" "$src_summary_fn" '|' \
	skip_uptodate '|' \
	raw2hr > "$res_fn"

    output_results
    exit 0
fi

########################################
# -b
cat_ext_summary (){
    case "$PKG_SUMMARY" in
	*.gz)
	    gzip -dc "$PKG_SUMMARY";;
	*.bz2)
	    bzip2 -dc "$PKG_SUMMARY";;
	*)
	    cat "$PKG_SUMMARY";;
    esac
}

if test -n "$mode_bin"; then
    $PKG_INFO_CMD -X $pkg_info_opts "$@" > "$bin_summary_fn"
    cat_ext_summary | pkg_refresh_summary > "$ext_summary_fn"
    runpipe0 \
	pkg_cmp_summary -p "$bin_summary_fn" "$ext_summary_fn" '|' \
	sed '/^[+]/ d' '|' \
	skip_uptodate '|' \
	raw2hr > "$res_fn"

    output_results
    exit 0
fi

# online_summary (){
#     runawk -f str2regexp.awk -f xsystem.awk -v q="'" -e '
#     function print_summary (){
# 	cmd = "pkg_online_find -3 -r " q "PKGPATH:re:" accu_re "" q
# 	print cmd
# 	xsystem(cmd)
# 	accu_re = ""
#     }
#     {
# 	if (accu_re != "")
# 	    accu_re = accu_re "|"
# 	accu_re = accu_re str2regexp($0)
# 	if (length(accu_re) > 50) print_summary()
#     }
#     END {
# 	if (accu_re != "") print_summary()
#     }' "$@"
# }

# if test -n "$mode_online"; then
#     pkg_info -Q PKGPATH -a | head -50 > "$pkgpaths_fn"
#     online_summary "$pkgpaths_fn" 2>/dev/null #> "$src_summary_fn"
#     exit 55
#     pkg_info -Xa > "$bin_summary_fn"
#     runpipe0 \
# 	pkg_cmp_summary -p "$bin_summary_fn" "$src_summary_fn" '|' \
# 	skip_uptodate '|' \
# 	raw2hr
#     exit 0
# fi
