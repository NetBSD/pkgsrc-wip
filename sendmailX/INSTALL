# $NetBSD: INSTALL,v 1.6 2005/08/02 21:39:07 adrian_p Exp $

# Directories and files
#
SMXQD=@VARBASE@/spool/smx
DEFEDB=${SMXQD}/defedb
LOGDIR=@VARBASE@/log/smx
SED=@SED@
SMXETC=@SMXETC@
UNAME=@UNAME@

case ${STAGE} in

POST-INSTALL)

	# Put the users in the right groups
	# usermod -G <group> <user>
	#
	@USERMOD@ -G smxc smxs
	@USERMOD@ -G smxm smxs
	@USERMOD@ -G smxm smxq

	# Create the directories and set the permissions
	#
	${MKDIR} ${SMXQD}
	${CHMOD} 0755 ${SMXQD}

	for i in 0 1 2 3 4 5 6 7 8 9 A B C D E F
	do
		${MKDIR} ${SMXQD}/${i}
		${CHOWN} smxs:smxq ${SMXQD}/${i}
		${CHMOD} 0771 ${SMXQD}/${i}
	done

	${MKDIR} ${SMXQD}/defedb
	${CHOWN} smxq:smxq ${SMXQD}/defedb
	${CHMOD} 0700 ${SMXQD}/defedb

	for i in qmsmtps qmsmtpc qmsmar smtps ibdb ibdb/ibdb
	do
		${MKDIR} ${SMXQD}/${i}
		${CHMOD} 2770 ${SMXQD}/${i}
	done

	${CHOWN} smxq:smxm ${SMXQD}/qmsmar
	${CHOWN} smxq:smxc ${SMXQD}/qmsmtpc
	${CHOWN} smxq:smxs ${SMXQD}/qmsmtps
	${CHOWN} smxs:smxs ${SMXQD}/smtps
	${CHOWN} smxq:smxq ${SMXQD}/ibdb
	${CHOWN} smxq:smxq ${SMXQD}/ibdb/ibdb

	${CHMOD} 0700 ${SMXQD}/ibdb 
	${CHMOD} 0700 ${SMXQD}/ibdb/ibdb
	${CHMOD} 0750 ${SMXQD}/smtps 

	# Setup logging and permissions on log files
	#
	${MKDIR} ${LOGDIR}
	${TOUCH} ${LOGDIR}/qmgr.log
	${TOUCH} ${LOGDIR}/smar.log
	${TOUCH} ${LOGDIR}/smtpc.log
	${TOUCH} ${LOGDIR}/smtps.log

	${CHOWN} smxq:operator ${LOGDIR}/qmgr.log
	${CHOWN} smxm:operator ${LOGDIR}/smar.log
	${CHOWN} smxc:operator ${LOGDIR}/smtpc.log
	${CHOWN} smxs:operator ${LOGDIR}/smtps.log

	${CHMOD} 0644 ${LOGDIR}/qmgr.log
	${CHMOD} 0644 ${LOGDIR}/smar.log
	${CHMOD} 0644 ${LOGDIR}/smtpc.log
	${CHMOD} 0644 ${LOGDIR}/smtps.log

	# Fix the GID in smx.conf
	#
	GID=`@PREFIX@/bin/runas smxc @PREFIX@/bin/t-getgroup smxc 2>/dev/null`

	${SED} "s/@SMXCGID@/${GID}/g" ${SMXETC}/smx.conf \
		> ${SMXETC}/smx.conf.new
	${MV} ${SMXETC}/smx.conf.new ${SMXETC}/smx.conf

	${CHOWN} smx:smx ${SMXETC}/smx.conf 
	${CHMOD} 0644 ${SMXETC}/smx.conf

	# Fix the hostname in mt
	#
	HOSTNAME=`${UNAME} -n`
	${ECHO} "${HOSTNAME} 	lmtp:" >> ${SMXETC}/mt

	;;

esac
