# $NetBSD$
#
###########################################################
#                  Generated by fbsd2pkg                  #
#              Sat Aug 12 11:25:27 CDT 2023               #
###########################################################

###########################################################
# Unconverted and partially converted FreeBSD port syntax:

#LICENSE_COMB=		multi
#LICENSE_FILE_PD=	${WRKSRC}/LICENSE
#LICENSE_DISTFILES_LGPL21+ =
#USE_LDCONFIG=		${PREFIX}/lib64

DISTNAME=		sra-tools-3.0.6
CATEGORIES=		biology
MASTER_SITES=		${MASTER_SITE_GITHUB:=outpaddling/}
GITHUB_TAG=		de3d50d111874171766fd017c8cbcf92a9009263
GITHUB_SUBMODULES+=	outpaddling ncbi-vdb 802ae6e ncbi-vdb

OWNER=		bacon@NetBSD.org
HOMEPAGE=	https://github.com/ncbi/sra-tools
COMMENT=	NCBI's toolkit for handling data in INSDC Sequence Read Archives
# Check this
LICENSE=	public-domain

# Test and change if necessary.
# MAKE_JOBS_SAFE=	no

# Upstream explicitly supports specific platforms
# Untested on other platforms, aarch64 support was recently added upstream
ONLY_FOR_PLATFORM=	*-*-aarch64 *-*-x86_64

USE_LANGUAGES=	c c++
USE_TOOLS+=	bash bison cmake
# USE_JAVA=	yes
# Builds with earlier versions, but ngs-doc plist differs if jdk17 is present
# USE_JAVA2=	17

# The config.c and file-path.posix.cpp reinplaces follow
# static patches.  Run "make clean patch" before updating
# those patches so this reinplace does not get added to them.
SUBST_CLASSES+=		etcdir
SUBST_STAGE.etcdir=	pre-configure
SUBST_SED.etcdir+=	-e 's|"/etc/ncbi"|"${PREFIX}/etc/ncbi"|g'
SUBST_FILES.etcdir+=	ncbi-vdb/libs/kfg/config.c

SUBST_CLASSES+=		binpath
SUBST_STAGE.binpath=	pre-configure
SUBST_SED.binpath+=	-e 's|/usr/local/bin|${PREFIX}/bin|g'
SUBST_FILES.binpath+=	tools/external/driver-tool/file-path.posix.cpp

SUBST_CLASSES+=		submoddir
SUBST_STAGE.submoddir=	pre-configure
SUBST_SED.submoddir+=	-e 's|/../ncbi-vdb|/ncbi-vdb|g'
SUBST_FILES.submoddir+=	CMakeLists.txt

# FreeBSD's SHEBANG_FILES may include bash, perl, python, etc.
# I don't know which is which, so you'll have to finish.
# Add bash, etc. to USE_TOOLS if used below.
REPLACE_BASH=	*/*.sh */*/*.sh */*/*/*.sh

USE_CMAKE=	yes
# Check this
CMAKE_ARGS+=	-DVDB_LIBDIR:STRING=${WRKSRC}/ncbi-vdb/build/lib
CMAKE_ARGS+=	-DCMAKE_VERBOSE_MAKEFILE:BOOL=ON
BUILDLINK_TRANSFORM.NetBSD+=	rm:-ldl	# ncbi-vdb/CMakeLists.posix.txt

EXAMPLESDIR=	${PREFIX}/share/examples/sra-tools

.include "../../mk/bsd.prefs.mk"

# FIXME: Check for libstdc++-static on Linux
pre-configure:
.if ${OPSYS} == NetBSD
	${RM} ${WRKSRC}/ncbi-vdb/interfaces/cc/gcc/x86_64/byteswap.h
.endif
	cd ${WRKSRC}/ncbi-vdb/build && cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON .. && make

post-install:
	${STRIP} ${DESTDIR}${PREFIX}/bin/*.${PKGVERSION_NOREV}
	${MV} ${DESTDIR}${PREFIX}/share/examples ${DESTDIR}${PREFIX}/share/examples-sratools
	${MKDIR} ${DESTDIR}${EXAMPLESDIR}
	${MV} ${DESTDIR}${PREFIX}/share/examples-sratools/* ${DESTDIR}${EXAMPLESDIR}
	${RMDIR} ${DESTDIR}${PREFIX}/share/examples-sratools
	${MV} ${DESTDIR}${PREFIX}/share/examples-python ${DESTDIR}${EXAMPLESDIR}/python
	# FIXME: Build is detecting Java somehow
	${RM} -rf ${DESTDIR}${PREFIX}/jar
	${RM} -rf ${DESTDIR}${PREFIX}/share/examples-java
	${RM} -rf ${DESTDIR}${PREFIX}/share/javadoc

# Shouldn't epoll bl3 check this?
.if ${OPSYS} != Linux
.include "../../devel/libepoll-shim/buildlink3.mk"
.endif

# Triggers openjdk install on Linux even if installed via Yum
# FIXME: Should we just build without Java to avoid these issues?
# .if ${OPSYS} == NetBSD
# .include "../../mk/java-vm.mk"
# .endif
.include "../../mk/pthread.buildlink3.mk"
.include "../../devel/cmake/build.mk"
.include "../../textproc/libxml2/buildlink3.mk"
.include "../../devel/hdf5/buildlink3.mk"
.include "../../archivers/zstd/buildlink3.mk"
# FIXME: cmake is not finding this
.include "../../security/mbedtls/buildlink3.mk"
.include "../../mk/bsd.pkg.mk"
